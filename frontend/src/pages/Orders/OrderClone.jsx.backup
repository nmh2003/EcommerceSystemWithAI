/**
 * ============================================================================
 * PHASE 10A - PART 13: ORDER PAGE (CLONE ECOM)
 * ============================================================================
 *
 * üìå M·ª§C ƒê√çCH:
 * - Clone Order page t·ª´ Ecom sang Fin - "GI·ªêNG Y X√å ƒê√öC"
 * - Hi·ªÉn th·ªã CHI TI·∫æT ƒë∆°n h√†ng SAU KHI ƒë·∫∑t h√†ng th√†nh c√¥ng
 * - User c√≥ th·ªÉ xem: Items table, Shipping info, Payment status, Order summary
 * - Admin c√≥ th·ªÉ: Mark as Delivered (n·∫øu ƒë√£ paid v√† ch∆∞a delivered)
 *
 * üìå KH√ÅC BI·ªÜT ECOM VS FIN:
 * - Ecom: Redux (useGetOrderDetailsQuery), PayPal integration, useDeliverOrderMutation
 * - Fin: fetch API (GET /api/orders/:id, PUT /api/orders/:id/deliver), localStorage userInfo, cookie JWT
 * - Ecom: Tailwind CSS (className="container flex flex-col ml-[10rem]")
 * - Fin: Pure CSS (.order-container { display: flex; flex-direction: column; })
 * - Authentication: Fin d√πng cookie httpOnly thay v√¨ Authorization header nh∆∞ Ecom
 *
 * üìå FLOW:
 * 1. PlaceOrder page ‚Üí POST /api/orders ‚Üí Navigate to /order/:id
 * 2. Order page mount ‚Üí GET /api/orders/:id (fetch order details)
 * 3. Display: Items table + Shipping info + Payment/Delivery status + Order summary
 * 4. Admin click "Mark as Delivered" ‚Üí PUT /api/orders/:id/deliver ‚Üí Refetch order
 *
 * üìå KI·∫æN TH·ª®C √ÅP D·ª§NG (10 BU·ªîI H·ªåC):
 * - Bu·ªïi 6: fetch API, useEffect, async/await, loading/error state
 * - Bu·ªïi 7: useParams (l·∫•y order ID t·ª´ URL /order/:id)
 * - Bu·ªïi 10: JWT token trong cookie httpOnly, credentials: "include", localStorage userInfo
 * - Bu·ªïi 3: useState (order, loading, error, deliverLoading)
 * - Bu·ªïi 4: Event handling (deliverHandler button click)
 * - Bu·ªïi 2: HTML table, CSS flexbox, responsive design
 *
 * üìå API ENDPOINTS:
 * - GET http://localhost:1337/api/orders/:id (get order details)
 * - PUT http://localhost:1337/api/orders/:id/deliver (mark as delivered - admin only)
 * - Authentication: credentials: "include" (g·ª≠i cookie JWT httpOnly)
 * - Headers: { "Content-Type": "application/json" }
 */

// ============================================================================
// IMPORT C√ÅC DEPENDENCIES
// ============================================================================

import { useState, useEffect, useMemo } from "react";
/**
 * useState (Bu·ªïi 3):
 * - Qu·∫£n l√Ω state c·ªßa component (order data, loading, error)
 * - Syntax: const [state, setState] = useState(initialValue)
 *
 * useEffect (Bu·ªïi 6):
 * - Ch·∫°y side effects (fetch API, localStorage, subscriptions)
 * - Ch·∫°y KHI component mount (dependencies = [])
 * - Ch·∫°y KHI dependencies thay ƒë·ªïi (dependencies = [orderId, token])
 *
 * useMemo (Bu·ªïi 8):
 * - Memoize expensive computations
 * - Prevent unnecessary re-computations
 * - Here: Memoize userInfo to prevent infinite re-renders
 */

import { Link, useParams } from "react-router-dom";
/**
 * Link (Bu·ªïi 7):
 * - Component c·ªßa React Router ƒë·ªÉ t·∫°o link
 * - <Link to="/path">Text</Link> ‚Üí Kh√¥ng reload page (SPA)
 *
 * useParams (Bu·ªïi 7):
 * - Hook l·∫•y URL parameters
 * - URL: /order/abc123 ‚Üí useParams() = { id: "abc123" }
 */

import Message from "../../components/Message";
/**
 * Message component:
 * - Hi·ªÉn th·ªã th√¥ng b√°o l·ªói/success/warning
 * - Props: variant (danger/success/warning), children (message text)
 */

import Loader from "../../components/Loader";
/**
 * Loader component:
 * - Hi·ªÉn th·ªã loading spinner khi ƒëang fetch API
 * - Component ƒë∆°n gi·∫£n: <div className="loader">Loading...</div>
 */

import { getUser } from "../../utils/localStorage";
/**
 * getUser utility:
 * - L·∫•y th√¥ng tin user t·ª´ localStorage v·ªõi key "my-cms-user"
 * - Tr·∫£ v·ªÅ user object ho·∫∑c null n·∫øu kh√¥ng c√≥
 * - Thay th·∫ø cho localStorage.getItem("user") + JSON.parse()
 */

import { vndToUsd } from "../../utils/currency";
/**
 * Currency conversion utility:
 * - vndToUsd: Convert VND to USD for PayPal integration
 * - PayPal doesn't support VND, so we need to convert currency
 */

import "./OrderClone.css";
/**
 * Import CSS file ƒë·ªÉ style component n√†y
 * - Pure CSS (KH√îNG d√πng Tailwind nh∆∞ Ecom)
 * - Clone Tailwind classes sang CSS thu·∫ßn
 */

// ============================================================================
// COMPONENT CH√çNH: Order
// ============================================================================

const Order = function () {
  // -------------------------------------------------------------------------
  // 1. L·∫§Y ORDER ID T·ª™ URL
  // -------------------------------------------------------------------------
  /**
   * useParams() hook t·ª´ React Router
   *
   * V√ç D·ª§ URL: /order/abc123
   * ‚Üí useParams() tr·∫£ v·ªÅ: { id: "abc123" }
   *
   * Destructure ƒë·ªÉ l·∫•y id, ƒë·ªïi t√™n th√†nh orderId cho r√µ nghƒ©a
   *
   * T·∫†I SAO C·∫¶N orderId?
   * - ƒê·ªÉ g·ªçi API GET /api/orders/:id
   * - ƒê·ªÉ fetch chi ti·∫øt ƒë∆°n h√†ng t·ª´ backend
   */
  const { id: orderId } = useParams();

  // -------------------------------------------------------------------------
  // 2. L·∫§Y USER TOKEN T·ª™ LOCALSTORAGE (KH√îNG C·∫¶N TOKEN, D√ôNG COOKIE)
  // -------------------------------------------------------------------------
  /**
   * Trong project n√†y, authentication d√πng JWT trong cookie httpOnly
   * Frontend kh√¥ng th·ªÉ ƒë·ªçc token t·ª´ cookie, nh∆∞ng browser t·ª± ƒë·ªông g·ª≠i cookie khi credentials: "include"
   * Kh√¥ng c·∫ßn l·∫•y token t·ª´ localStorage nh∆∞ trong Ecom (d√πng Redux + localStorage token)
   *
   * useMemo (Bu·ªïi 8): Memoize userInfo to prevent infinite re-renders
   * - getUser() returns new object reference each call (JSON.parse)
   * - Without memoization: userInfo changes on every render ‚Üí infinite useEffect calls
   * - With memoization: userInfo stable unless localStorage actually changes
   */
  const userInfo = useMemo(() => getUser(), []);

  // -------------------------------------------------------------------------
  // 3. KHAI B√ÅO STATE
  // -------------------------------------------------------------------------

  /**
   * formatPriceVN - Format gi√° v·ªõi VNƒê (gi·ªëng AdminDashboard)
   */
  function formatPriceVN(price) {
    if (typeof price !== "number") {
      return "0 ƒë";
    }
    return price.toLocaleString("vi-VN") + " ƒë";
  }

  /**
   * order (Bu·ªïi 3):
   * - L∆∞u th√¥ng tin ƒë∆°n h√†ng t·ª´ API
   * - Ban ƒë·∫ßu: null (ch∆∞a fetch)
   * - Sau fetch: object { id, orderItems, shippingAddress, ... }
   *
   * ORDER OBJECT STRUCTURE (t·ª´ backend):
   * {
   *   _id: "order123",
   *   user: { username: "John", email: "john@example.com" },
   *   orderItems: [
   *     { product: "p1", name: "Product 1", qty: 2, price: 12.99, image: "/path" }
   *   ],
   *   shippingAddress: {
   *     address: "123 Main St",
   *     city: "New York",
   *     postalCode: "10001",
   *     country: "USA"
   *   },
   *   paymentMethod: "PayPal",
   *   itemsPrice: 25.98,
   *   shippingPrice: 10.00,
   *   taxPrice: 3.90,
   *   totalPrice: 39.88,
   *   isPaid: false,
   *   isDelivered: false,
   *   paidAt: null,
   *   deliveredAt: null,
   *   createdAt: "2025-10-16T10:00:00.000Z"
   * }
   */
  const [order, setOrder] = useState(null);

  /**
   * isLoading (Bu·ªïi 6):
   * - Tr·∫°ng th√°i ƒëang fetch API
   * - true: ƒêang loading ‚Üí Hi·ªÉn th·ªã <Loader />
   * - false: ƒê√£ load xong ‚Üí Hi·ªÉn th·ªã content
   *
   * T·∫†I SAO C·∫¶N LOADING STATE?
   * - C·∫£i thi·ªán UX: User bi·∫øt app ƒëang l√†m g√¨
   * - Tr√°nh hi·ªÉn th·ªã empty screen khi ƒëang fetch
   * - Disable buttons khi ƒëang loading (tr√°nh double-click)
   */
  const [isLoading, setIsLoading] = useState(true);

  /**
   * error (Bu·ªïi 6):
   * - L∆∞u th√¥ng b√°o l·ªói n·∫øu fetch API th·∫•t b·∫°i
   * - null: Kh√¥ng c√≥ l·ªói
   * - string: Th√¥ng b√°o l·ªói ("Failed to fetch order", "Unauthorized", ...)
   *
   * ERROR CASES:
   * - 401 Unauthorized: Token h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá
   * - 403 Forbidden: User kh√¥ng c√≥ quy·ªÅn xem order n√†y
   * - 404 Not Found: Order ID kh√¥ng t·ªìn t·∫°i
   * - 500 Server Error: Backend l·ªói
   * - Network Error: Kh√¥ng connect ƒë∆∞·ª£c backend
   */
  const [error, setError] = useState(null);

  /**
   * deliverLoading:
   * - Tr·∫°ng th√°i ƒëang g·ªçi API "Mark as Delivered"
   * - true: ƒêang loading ‚Üí Disable button, show loading text
   * - false: Idle ‚Üí Button clickable
   *
   * T·∫†I SAO C·∫¶N STATE RI√äNG?
   * - isLoading d√πng cho fetch order (mount)
   * - deliverLoading d√πng cho deliver action (click button)
   * - T√°ch bi·ªát ƒë·ªÉ UI r√µ r√†ng h∆°n
   */
  const [deliverLoading, setDeliverLoading] = useState(false);

  /**
   * paymentModal: Hi·ªÉn th·ªã modal thanh to√°n
   * - true: Hi·ªán modal nh·∫≠p s·ªë ti·ªÅn
   * - false: ·∫®n modal
   */
  const [paymentModal, setPaymentModal] = useState(false);

  /**
   * paymentAmount: S·ªë ti·ªÅn nh·∫≠p v√†o form
   * - String ƒë·ªÉ d·ªÖ validate v√† format
   */
  const [paymentAmount, setPaymentAmount] = useState("");

  /**
   * paymentLoading: Tr·∫°ng th√°i ƒëang x·ª≠ l√Ω thanh to√°n
   */
  const [paymentLoading, setPaymentLoading] = useState(false);

  /**
   * PayPal states
   */
  const [paypalClientId, setPaypalClientId] = useState(null);
  const [paypalLoading, setPaypalLoading] = useState(false);

  // -------------------------------------------------------------------------
  // 4. FETCH ORDER DATA KHI COMPONENT MOUNT
  // -------------------------------------------------------------------------

  /**
   * useEffect(() => {...}, [dependencies]) (Bu·ªïi 6)
   *
   * CH·∫†Y KHI N√ÄO?
   * - L·∫ßn ƒë·∫ßu component mount (render)
   * - Khi dependencies thay ƒë·ªïi (orderId, token)
   *
   * DEPENDENCIES: [orderId, token]
   * - orderId thay ƒë·ªïi ‚Üí Fetch order m·ªõi (n·∫øu navigate sang order kh√°c)
   * - token thay ƒë·ªïi ‚Üí Fetch l·∫°i v·ªõi token m·ªõi (n·∫øu login/logout)
   *
   * T·∫†I SAO C·∫¶N FETCH?
   * - PlaceOrder page ch·ªâ navigate v·ªõi order ID
   * - Order page c·∫ßn FULL th√¥ng tin ƒë·ªÉ hi·ªÉn th·ªã
   * - Ph·∫£i g·ªçi API GET /api/orders/:id
   */
  useEffect(
    function () {
      // -----------------------------------------------------------------------
      // B∆Ø·ªöC 1: VALIDATE USER LOGIN (THAY V√å TOKEN)
      // -----------------------------------------------------------------------
      /**
       * Thay v√¨ check token, check userInfo t·ª´ localStorage
       * N·∫øu kh√¥ng c√≥ userInfo ‚Üí User ch∆∞a login ‚Üí Hi·ªÉn th·ªã error
       * Authentication s·∫Ω ƒë∆∞·ª£c verify b·ªüi backend qua cookie JWT
       */
      if (!userInfo) {
        setError("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem chi ti·∫øt ƒë∆°n h√†ng");
        setIsLoading(false);
        return; // D·ª´ng execution
      }

      // -----------------------------------------------------------------------
      // B∆Ø·ªöC 2: DEFINE ASYNC FUNCTION
      // -----------------------------------------------------------------------
      /**
       * T·∫†I SAO PH·∫¢I T·∫†O ASYNC FUNCTION B√äN TRONG?
       * - useEffect callback KH√îNG TH·ªÇ l√† async function tr·ª±c ti·∫øp
       * - Ph·∫£i t·∫°o async function b√™n trong, r·ªìi g·ªçi n√≥
       *
       * PATTERN:
       * useEffect(() => {
       *   const fetchData = async () => { ... };
       *   fetchData();
       * }, []);
       */
      const fetchOrder = async function () {
        try {
          // -------------------------------------------------------------------
          // B∆Ø·ªöC 3: SET LOADING TRUE, CLEAR ERROR
          // -------------------------------------------------------------------
          setIsLoading(true);
          setError(null);

          // -------------------------------------------------------------------
          // B∆Ø·ªöC 4: FETCH API
          // -------------------------------------------------------------------
          /**
           * fetch(url, options) (Bu·ªïi 6)
           * - url: API endpoint v·ªõi order ID
           * - options: { method, headers }
           *
           * URL: http://localhost:1337/api/orders/:id
           * - Sails.js backend ch·∫°y ·ªü port 1337
           * - Route: GET /api/orders/:id
           * - Controller: OrderController.findOne()
           *
           * HEADERS:
           * - Content-Type: application/json
           *   ‚Üí Server bi·∫øt client g·ª≠i JSON format
           * - Authorization: Bearer <token>
           *   ‚Üí JWT authentication
           *   ‚Üí Backend verify token, l·∫•y user ID
           */
          const response = await fetch(
            `http://localhost:1337/api/orders/${orderId}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include", // G·ª≠i cookie JWT thay v√¨ Authorization header
            }
          );

          // -------------------------------------------------------------------
          // B∆Ø·ªöC 5: CHECK RESPONSE STATUS
          // -------------------------------------------------------------------
          /**
           * response.ok (Bu·ªïi 6):
           * - true: Status code 200-299 (success)
           * - false: Status code 400-599 (error)
           *
           * ERROR HANDLING:
           * - 401 Unauthorized: Token kh√¥ng h·ª£p l·ªá
           * - 403 Forbidden: User kh√¥ng c√≥ quy·ªÅn
           * - 404 Not Found: Order kh√¥ng t·ªìn t·∫°i
           * - 500 Server Error: Backend l·ªói
           */
          if (!response.ok) {
            // Parse error message t·ª´ backend
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to fetch order");
          }

          // -------------------------------------------------------------------
          // B∆Ø·ªöC 6: PARSE RESPONSE JSON
          // -------------------------------------------------------------------
          /**
           * response.json() (Bu·ªïi 6):
           * - Parse response body th√†nh JavaScript object
           * - Tr·∫£ v·ªÅ Promise<any> ‚Üí Ph·∫£i await
           *
           * RESPONSE DATA: Order object t·ª´ backend
           */
          const data = await response.json();

          // -------------------------------------------------------------------
          // B∆Ø·ªöC 7: UPDATE STATE
          // -------------------------------------------------------------------
          /**
           * setOrder(data):
           * - L∆∞u order data v√†o state
           * - Component re-render
           * - UI hi·ªÉn th·ªã order details
           */
          setOrder(data);
        } catch (err) {
          // ---------------------------------------------------------------------
          // HANDLE ERROR
          // ---------------------------------------------------------------------
          /**
           * try/catch (Bu·ªïi 6):
           * - Catch m·ªçi l·ªói trong try block
           * - err.message: Th√¥ng b√°o l·ªói
           * - setError(): L∆∞u error v√†o state
           *
           * ERROR TYPES:
           * - Network error: Kh√¥ng connect ƒë∆∞·ª£c backend
           * - HTTP error: response.ok = false
           * - Parse error: response.json() failed
           */
          console.error("Error fetching order:", err);
          setError(err.message);
        } finally {
          // ---------------------------------------------------------------------
          // FINALLY: CH·∫†Y D√ô SUCCESS HAY ERROR
          // ---------------------------------------------------------------------
          /**
           * finally (Bu·ªïi 6):
           * - Ch·∫°y sau try ho·∫∑c catch
           * - D√πng ƒë·ªÉ cleanup (set loading false)
           * - ƒê·∫£m b·∫£o loading spinner t·∫Øt d√π c√≥ l·ªói hay kh√¥ng
           */
          setIsLoading(false);
        }
      };

      // -----------------------------------------------------------------------
      // B∆Ø·ªöC 8: G·ªåI ASYNC FUNCTION
      // -----------------------------------------------------------------------
      fetchOrder();
    },
    [orderId, userInfo]
  );
  // Dependencies: Fetch l·∫°i khi orderId ho·∫∑c token thay ƒë·ªïi

  // -------------------------------------------------------------------------
  // 4B. PAYPAL INTEGRATION
  // -------------------------------------------------------------------------

  /**
   * PayPal Integration:
   * - Fetch PayPal client ID t·ª´ backend
   * - Load PayPal script
   * - Set up PayPal button
   */
  useEffect(() => {
    const loadPayPal = async () => {
      try {
        // Fetch PayPal client ID
        const response = await fetch(
          "http://localhost:1337/api/config/paypal",
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          }
        );

        if (response.ok) {
          const data = await response.json();
          setPaypalClientId(data.clientId);
        }
      } catch (err) {
        console.error("Error loading PayPal:", err);
      }
    };

    loadPayPal();
  }, []);

  // -------------------------------------------------------------------------
  // 4C. PAYPAL BUTTON SETUP
  // -------------------------------------------------------------------------

  /**
   * PayPal Button Setup:
   * - Load PayPal script when client ID is available
   * - Create PayPal button for payment
   */
  useEffect(() => {
    if (!paypalClientId) {
      console.log("‚è≥ Waiting for PayPal client ID...");
      return;
    }

    console.log(
      "üöÄ Setting up PayPal button with client ID:",
      paypalClientId.substring(0, 10) + "..."
    );

    // Load PayPal script
    const script = document.createElement("script");
    script.src = `https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=USD`;
    script.async = true;
    script.onload = () => {
      console.log("üì¶ PayPal script loaded successfully");
      // PayPal script loaded, render button
      if (window.paypal) {
        console.log("üéØ PayPal SDK available, rendering button...");
        window.paypal
          .Buttons({
            createOrder: (data, actions) => {
              // Convert VND to USD for PayPal
              const usdAmount = vndToUsd(order.totalPrice);

              return actions.order.create({
                purchase_units: [
                  {
                    amount: {
                      value: usdAmount.toFixed(2),
                      currency_code: "USD",
                    },
                    description: `Order ${order.id || order._id}`,
                  },
                ],
              });
            },
            onApprove: async (data, actions) => {
              try {
                setPaypalLoading(true);

                // Capture the payment
                const details = await actions.order.capture();

                // Process payment on backend
                const response = await fetch(
                  `http://localhost:1337/api/orders/${orderId}/pay`,
                  {
                    method: "PUT",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    credentials: "include",
                    body: JSON.stringify({
                      amount: order.totalPrice,
                      paypalOrderId: details.id,
                      paypalPayerId: details.payer.payer_id,
                    }),
                  }
                );

                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.message || "PayPal payment failed");
                }

                // Refetch order to update UI
                const orderResponse = await fetch(
                  `http://localhost:1337/api/orders/${orderId}`,
                  {
                    method: "GET",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    credentials: "include",
                  }
                );

                if (orderResponse.ok) {
                  const updatedOrder = await orderResponse.json();
                  setOrder(updatedOrder);
                }

                alert("Thanh to√°n PayPal th√†nh c√¥ng!");
              } catch (err) {
                console.error("PayPal payment error:", err);
                alert("Thanh to√°n PayPal th·∫•t b·∫°i: " + err.message);
              } finally {
                setPaypalLoading(false);
              }
            },
            onError: (err) => {
              console.error("PayPal error:", err);
              alert("C√≥ l·ªói x·∫£y ra v·ªõi PayPal. Vui l√≤ng th·ª≠ l·∫°i.");
            },
          })
          .render("#paypal-button-container");
      }
    };

    document.head.appendChild(script);

    // Cleanup
    return () => {
      const existingScript = document.querySelector(
        `script[src*="${paypalClientId}"]`
      );
      if (existingScript) {
        document.head.removeChild(existingScript);
      }
    };
  }, [paypalClientId, order, orderId]);

  // -------------------------------------------------------------------------
  // 5. HANDLER: MARK AS DELIVERED
  // -------------------------------------------------------------------------

  /**
   * deliverHandler (Bu·ªïi 4):
   * - Event handler khi admin click button "Mark as Delivered"
   * - G·ªçi API PUT /api/orders/:id/deliver
   * - Update isDelivered = true, deliveredAt = now
   * - Refetch order ƒë·ªÉ c·∫≠p nh·∫≠t UI
   *
   * FLOW:
   * 1. Admin click button
   * 2. deliverHandler() g·ªçi
   * 3. Set deliverLoading = true (disable button)
   * 4. PUT /api/orders/:id/deliver
   * 5. Refetch order (g·ªçi l·∫°i fetch API)
   * 6. Set deliverLoading = false
   * 7. UI update (hi·ªÉn th·ªã "Delivered")
   *
   * ONLY ADMIN:
   * - Backend check token ‚Üí l·∫•y user ID
   * - Backend check user.isAdmin = true
   * - N·∫øu kh√¥ng ph·∫£i admin ‚Üí 403 Forbidden
   */
  const deliverHandler = async function () {
    try {
      // -----------------------------------------------------------------------
      // B∆Ø·ªöC 1: SET LOADING TRUE
      // -----------------------------------------------------------------------
      setDeliverLoading(true);

      // -----------------------------------------------------------------------
      // B∆Ø·ªöC 2: CALL API PUT
      // -----------------------------------------------------------------------
      /**
       * PUT /api/orders/:id/deliver
       * - Method: PUT (update resource)
       * - Headers: Authorization Bearer token
       * - Body: empty (kh√¥ng c·∫ßn body)
       *
       * BACKEND ACTION:
       * - Verify token ‚Üí l·∫•y user ID
       * - Check user.isAdmin = true
       * - Update order: isDelivered = true, deliveredAt = new Date()
       * - Return updated order
       */
      const response = await fetch(
        `http://localhost:1337/api/orders/${orderId}/deliver`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // G·ª≠i cookie JWT
        }
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || "Failed to mark as delivered");
      }

      // -----------------------------------------------------------------------
      // B∆Ø·ªöC 3: REFETCH ORDER
      // -----------------------------------------------------------------------
      /**
       * Sau khi deliver th√†nh c√¥ng, c·∫ßn refetch order
       * - ƒê·ªÉ l·∫•y order m·ªõi v·ªõi isDelivered = true
       * - ƒê·ªÉ UI update (show "Delivered" badge)
       *
       * C√ÅCH 1: G·ªçi l·∫°i fetch API (nh∆∞ ·ªü useEffect)
       * C√ÅCH 2: Update state tr·ª±c ti·∫øp (optimistic update)
       *
       * ·ªû ƒë√¢y d√πng C√ÅCH 1 (refetch) ƒë·ªÉ ƒë·∫£m b·∫£o data ƒë·ªìng b·ªô
       */
      const orderResponse = await fetch(
        `http://localhost:1337/api/orders/${orderId}`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // G·ª≠i cookie JWT
        }
      );

      if (orderResponse.ok) {
        const updatedOrder = await orderResponse.json();
        setOrder(updatedOrder);
      }
    } catch (err) {
      // -----------------------------------------------------------------------
      // HANDLE ERROR
      // -----------------------------------------------------------------------
      console.error("Error marking as delivered:", err);
      setError(err.message);
    } finally {
      // -----------------------------------------------------------------------
      // SET LOADING FALSE
      // -----------------------------------------------------------------------
      setDeliverLoading(false);
    }
  };

  // -------------------------------------------------------------------------
  // 6. HANDLER: PAYMENT
  // -------------------------------------------------------------------------

  /**
   * paymentHandler:
   * - X·ª≠ l√Ω thanh to√°n ƒë∆°n h√†ng
   * - Validate s·ªë ti·ªÅn nh·∫≠p v√†o
   * - G·ªçi API PUT /api/orders/:id/pay
   * - Update isPaid = true, paidAt = now
   */
  const paymentHandler = async function () {
    try {
      // Validate s·ªë ti·ªÅn
      const amount = parseFloat(paymentAmount);
      if (isNaN(amount) || amount <= 0) {
        throw new Error("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá");
      }

      if (amount < order.totalPrice) {
        throw new Error(
          `S·ªë ti·ªÅn ph·∫£i √≠t nh·∫•t ${formatPriceVN(order.totalPrice)}`
        );
      }

      setPaymentLoading(true);

      // G·ªçi API thanh to√°n
      const response = await fetch(
        `http://localhost:1337/api/orders/${orderId}/pay`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify({ amount: amount }),
        }
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || "Thanh to√°n th·∫•t b·∫°i");
      }

      // Refetch order ƒë·ªÉ c·∫≠p nh·∫≠t UI
      const orderResponse = await fetch(
        `http://localhost:1337/api/orders/${orderId}`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
        }
      );

      if (orderResponse.ok) {
        const updatedOrder = await orderResponse.json();
        setOrder(updatedOrder);
      }

      // ƒê√≥ng modal v√† reset form
      setPaymentModal(false);
      setPaymentAmount("");
    } catch (err) {
      console.error("Error processing payment:", err);
      setError(err.message);
    } finally {
      setPaymentLoading(false);
    }
  };

  // -------------------------------------------------------------------------
  // 7. RENDER LOGIC - CONDITIONAL RENDERING
  // -------------------------------------------------------------------------

  /**
   * CONDITIONAL RENDERING (Bu·ªïi 3):
   * 1. N·∫øu ƒëang loading ‚Üí Hi·ªÉn th·ªã <Loader />
   * 2. N·∫øu c√≥ error ‚Üí Hi·ªÉn th·ªã <Message variant="danger">
   * 3. N·∫øu kh√¥ng c√≥ order data ‚Üí Hi·ªÉn th·ªã empty message
   * 4. N·∫øu c√≥ order data ‚Üí Hi·ªÉn th·ªã order details
   */

  // CASE 1: Loading
  if (isLoading) {
    return <Loader />;
  }

  // CASE 2: Error
  if (error) {
    return <Message variant="danger">{error}</Message>;
  }

  // CASE 3: No order data (edge case)
  if (!order) {
    return <Message variant="warning">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</Message>;
  }

  // -------------------------------------------------------------------------
  // 7. RENDER ORDER PAGE (CASE 4) - CLONE ECOM LAYOUT
  // -------------------------------------------------------------------------

  /**
   * LAYOUT (CLONE ECOM):
   * <div className="order-container">           // container flex flex-col ml-[10rem] md:flex-row
   *   <div className="order-main">              // md:w-2/3 pr-4
   *     <div className="order-items-section">   // border gray-300 mt-5 pb-4 mb-5
   *       <table className="order-items-table"> // w-[80%]
   *         // Items table: Image, Product, Quantity, Unit Price, Total
   *       </table>
   *     </div>
   *   </div>
   *
   *   <div className="order-sidebar">           // md:w-1/3
   *     <div className="order-shipping">        // mt-5 border-gray-300 pb-4 mb-4
   *       // Shipping info: Order ID, Name, Email, Address, Payment method
   *       // Payment status: Paid/Not paid
   *     </div>
   *
   *     <div className="order-summary">         // (implicit)
   *       // Order summary: Items, Shipping, Tax, Total
   *     </div>
   *
   *     <div className="order-actions">         // (only admin)
   *       <button>Mark as Delivered</button>
   *     </div>
   *   </div>
   * </div>
   */

  return (
    <div className="order-container">
      {/* =====================================================================
          LEFT COLUMN: ORDER ITEMS TABLE
          ===================================================================== */}
      <div className="order-main">
        <div className="order-items-section">
          {/* Check if order has items */}
          {order.orderItems.length === 0 ? (
            <Message>ƒê∆°n h√†ng tr·ªëng</Message>
          ) : (
            <div className="table-wrapper">
              <table className="order-items-table">
                {/* TABLE HEADER */}
                <thead>
                  <tr>
                    <th>H√¨nh ·∫£nh</th>
                    <th>S·∫£n ph·∫©m</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n gi√°</th>
                    <th>T·ªïng</th>
                  </tr>
                </thead>

                {/* TABLE BODY */}
                <tbody>
                  {/**
                   * map() (Bu·ªïi 6):
                   * - Loop qua m·ªói item trong orderItems
                   * - Return JSX element cho m·ªói item
                   * - key={index}: React c·∫ßn unique key
                   *
                   * ITEM OBJECT:
                   * {
                   *   product: "p1",        // Product ID
                   *   name: "Product 1",    // Product name
                   *   qty: 2,               // Quantity
                   *   price: 12.99,         // Unit price
                   *   image: "/path.jpg"    // Image URL
                   * }
                   */}
                  {order.orderItems.map(function (item, index) {
                    return (
                      <tr key={index}>
                        {/* Column 1: Image */}
                        <td>
                          <img
                            src={item.image}
                            alt={item.name}
                            className="item-image"
                          />
                        </td>

                        {/* Column 2: Product Name (Link) */}
                        <td>
                          {/**
                           * Link (Bu·ªïi 7):
                           * - T·∫°o link ƒë·∫øn product detail page
                           * - /product/:id (dynamic route)
                           * - Kh√¥ng reload page (SPA)
                           */}
                          <Link to={`/product/${item.product}`}>
                            {item.name}
                          </Link>
                        </td>

                        {/* Column 3: Quantity */}
                        <td className="text-center">{item.qty}</td>

                        {/* Column 4: Unit Price */}
                        <td className="text-center">
                          {formatPriceVN(item.price)}
                        </td>

                        {/* Column 5: Total */}
                        <td className="text-center">
                          {/**
                           * Calculate total: qty √ó price
                           * formatPriceVN: Format v·ªõi VNƒê
                           * VD: 2 √ó 26990000 = 53980000 ‚Üí "53,980,000 ƒë"
                           */}
                          {formatPriceVN(item.qty * item.price)}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>

      {/* =====================================================================
          RIGHT COLUMN: SHIPPING INFO + ORDER SUMMARY
          ===================================================================== */}
      <div className="order-sidebar">
        {/* ===================================================================
            SHIPPING SECTION
            =================================================================== */}
        <div className="order-shipping">
          <h2 className="section-title">Giao h√†ng</h2>

          {/* Order ID */}
          <p className="info-row">
            <strong className="info-label">ƒê∆°n h√†ng:</strong>{" "}
            {order.id || order._id}
          </p>

          {/* Customer Name */}
          <p className="info-row">
            <strong className="info-label">T√™n:</strong> {order.user.username}
          </p>

          {/* Customer Email */}
          <p className="info-row">
            <strong className="info-label">Email:</strong> {order.user.email}
          </p>

          {/* Shipping Address */}
          <p className="info-row">
            <strong className="info-label">ƒê·ªãa ch·ªâ:</strong>{" "}
            {order.shippingAddress.address}, {order.shippingAddress.city}{" "}
            {order.shippingAddress.postalCode}, {order.shippingAddress.country}
          </p>

          {/* Payment Method */}
          <p className="info-row">
            <strong className="info-label">Ph∆∞∆°ng th·ª©c:</strong>{" "}
            {order.paymentMethod}
          </p>

          {/* Payment Status */}
          {/**
           * Conditional rendering (Bu·ªïi 3):
           * - N·∫øu isPaid = true ‚Üí Hi·ªÉn th·ªã "Paid on [date]"
           * - N·∫øu isPaid = false ‚Üí Hi·ªÉn th·ªã "Not paid" + Payment button
           *
           * Message variant:
           * - success: Green background (paid)
           * - danger: Red background (not paid)
           */}
          {order.isPaid ? (
            <Message variant="success">
              ƒê√£ thanh to√°n v√†o {order.paidAt}
            </Message>
          ) : (
            <div>
              <Message variant="danger">Ch∆∞a thanh to√°n</Message>
              {/* Payment Button */}
              <button
                type="button"
                className="btn-payment"
                onClick={() => setPaymentModal(true)}
              >
                Thanh to√°n
              </button>

              {/* PayPal Button */}
              <div id="paypal-button-container" style={{ marginTop: "10px" }}>
                {paypalLoading && <Loader />}
              </div>
            </div>
          )}
        </div>

        {/* ===================================================================
            ORDER SUMMARY SECTION
            =================================================================== */}
        <div className="order-summary">
          <h2 className="section-title">T√≥m t·∫Øt ƒë∆°n h√†ng</h2>

          {/* Items Price */}
          <div className="summary-row">
            <span>S·∫£n ph·∫©m</span>
            <span>{formatPriceVN(order.itemsPrice)}</span>
          </div>

          {/* Shipping Price */}
          <div className="summary-row">
            <span>V·∫≠n chuy·ªÉn</span>
            <span>{formatPriceVN(order.shippingPrice)}</span>
          </div>

          {/* Tax Price */}
          <div className="summary-row">
            <span>Thu·∫ø</span>
            <span>{formatPriceVN(order.taxPrice)}</span>
          </div>

          {/* Total Price */}
          <div className="summary-row summary-total">
            <span>T·ªïng</span>
            <span>{formatPriceVN(order.totalPrice)}</span>
          </div>
        </div>

        {/* ===================================================================
            ADMIN ACTIONS: MARK AS DELIVERED
            =================================================================== */}
        {/**
         * CONDITIONAL RENDERING (Bu·ªïi 3):
         * - Ch·ªâ hi·ªÉn th·ªã button N·∫æU:
         *   + userInfo t·ªìn t·∫°i (user ƒë√£ login)
         *   + userInfo.isAdmin = true (user l√† admin)
         *   + order.isPaid = true (ƒë∆°n h√†ng ƒë√£ thanh to√°n)
         *   + order.isDelivered = false (ƒë∆°n h√†ng ch∆∞a giao)
         *
         * LOGIC:
         * - Admin ch·ªâ c√≥ th·ªÉ mark as delivered N·∫æU order ƒë√£ paid
         * - Kh√¥ng th·ªÉ deliver order ch∆∞a thanh to√°n
         * - N·∫øu ƒë√£ delivered r·ªìi ‚Üí Kh√¥ng hi·ªÉn th·ªã button
         */}
        {userInfo && userInfo.isAdmin && order.isPaid && !order.isDelivered && (
          <div className="order-actions">
            {/* Show loading text khi ƒëang deliver */}
            {deliverLoading && <Loader />}

            {/* Deliver Button */}
            <button
              type="button"
              className="btn-deliver"
              onClick={deliverHandler}
              disabled={deliverLoading}
            >
              {/**
               * Button text:
               * - ƒêang loading: "ƒêang ƒë√°nh d·∫•u..."
               * - Idle: "ƒê√°nh d·∫•u ƒë√£ giao"
               */}
              {deliverLoading ? "ƒêang ƒë√°nh d·∫•u..." : "ƒê√°nh d·∫•u ƒë√£ giao"}
            </button>
          </div>
        )}
      </div>

      {/* =====================================================================
          PAYMENT MODAL
          ===================================================================== */}
      {paymentModal && (
        <div className="payment-modal-overlay">
          <div className="payment-modal">
            <div className="payment-modal-header">
              <h2>Thanh to√°n ƒë∆°n h√†ng</h2>
              <button
                className="payment-modal-close"
                onClick={() => setPaymentModal(false)}
              >
                √ó
              </button>
            </div>
            <div className="payment-modal-body">
              <div className="payment-info">
                <p>
                  <strong>M√£ ƒë∆°n h√†ng:</strong> {order.id || order._id}
                </p>
                <p>
                  <strong>T·ªïng ti·ªÅn:</strong> {formatPriceVN(order.totalPrice)}
                </p>
              </div>
              <div className="payment-form">
                <label htmlFor="payment-amount">S·ªë ti·ªÅn thanh to√°n:</label>
                <input
                  id="payment-amount"
                  type="number"
                  value={paymentAmount}
                  onChange={(e) => setPaymentAmount(e.target.value)}
                  placeholder={`T·ªëi thi·ªÉu ${formatPriceVN(order.totalPrice)}`}
                  min={order.totalPrice}
                  step="0.01"
                />
              </div>
            </div>
            <div className="payment-modal-footer">
              <button
                type="button"
                className="btn-cancel"
                onClick={() => setPaymentModal(false)}
                disabled={paymentLoading}
              >
                H·ªßy
              </button>
              <button
                type="button"
                className="btn-confirm"
                onClick={paymentHandler}
                disabled={paymentLoading}
              >
                {paymentLoading ? "ƒêang x·ª≠ l√Ω..." : "X√°c nh·∫≠n thanh to√°n"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Order;

/**
 * ============================================================================
 * T·ªîNG K·∫æT KI·∫æN TH·ª®C
 * ============================================================================
 *
 * 1. REACT HOOKS (Bu·ªïi 9-10):
 *    - useState: Qu·∫£n l√Ω state (order, isLoading, error, deliverLoading)
 *    - useEffect: Fetch API khi component mount
 *    - useParams: L·∫•y order ID t·ª´ URL
 *
 * 2. FETCH API (Bu·ªïi 6):
 *    - GET /api/orders/:id: L·∫•y order details
 *    - PUT /api/orders/:id/deliver: Mark as delivered
 *    - async/await syntax
 *    - try/catch/finally error handling
 *    - JWT token trong Authorization header
 *
 * 3. LOCALSTORAGE (Bu·ªïi 7):
 *    - getItem("token"): L·∫•y JWT token
 *    - getItem("user"): L·∫•y user info
 *    - JSON.parse(): Parse JSON string th√†nh object
 *
 * 4. CONDITIONAL RENDERING (Bu·ªïi 3):
 *    - if (loading) return <Loader />
 *    - if (error) return <Message />
 *    - if (!order) return empty message
 *    - ternary: isPaid ? <success> : <danger>
 *    - && operator: userInfo && userInfo.isAdmin && <Button />
 *
 * 5. ARRAY METHODS (Bu·ªïi 6):
 *    - map(): Loop qua orderItems, render table rows
 *
 * 6. EVENT HANDLING (Bu·ªïi 4):
 *    - onClick={deliverHandler}: Handle button click
 *    - disabled={deliverLoading}: Disable button khi loading
 *
 * 7. CSS LAYOUT (Bu·ªïi 2):
 *    - Flexbox: container ‚Üí main (2/3) + sidebar (1/3)
 *    - Table: thead, tbody, tr, th, td
 *    - Responsive: @media queries
 *
 * 8. REACT ROUTER (Bu·ªïi 7):
 *    - Link: <Link to="/product/:id">
 *    - useParams: L·∫•y :id t·ª´ URL
 *
 * ============================================================================
 * SO S√ÅNH ECOM VS FIN
 * ============================================================================
 *
 * | Feature              | Ecom                          | Fin                          |
 * |----------------------|-------------------------------|------------------------------|
 * | Fetch Order          | useGetOrderDetailsQuery()     | fetch GET /api/orders/:id    |
 * | Refetch              | refetch()                     | fetch l·∫°i trong deliverHandler|
 * | Deliver Order        | useDeliverOrderMutation()     | fetch PUT /api/orders/:id/deliver|
 * | Loading State        | isLoading (from query)        | useState(isLoading)          |
 * | Error State          | error (from query)            | useState(error)              |
 * | User Info            | useSelector(state.auth)       | localStorage.getItem("user") |
 * | Styling              | Tailwind (className="...")    | Pure CSS (.order-container)  |
 * | PayPal Integration   | usePayPalScriptReducer()      | N/A (not implemented)        |
 *
 * ============================================================================
 * FLOW HO√ÄN CH·ªàNH
 * ============================================================================
 *
 * 1. USER ACTION: Navigate to /order/:id
 *     ‚Üì
 * 2. Order component mount
 *     ‚Üì
 * 3. useEffect: Fetch GET /api/orders/:id
 *     ‚Üì
 * 4. Backend: Verify token ‚Üí Check permission ‚Üí Return order
 *     ‚Üì
 * 5. setOrder(data) ‚Üí Component re-render
 *     ‚Üì
 * 6. Display: Items table + Shipping info + Order summary
 *     ‚Üì
 * 7. ADMIN ACTION (optional): Click "Mark as Delivered"
 *     ‚Üì
 * 8. deliverHandler: PUT /api/orders/:id/deliver
 *     ‚Üì
 * 9. Backend: Update isDelivered = true, deliveredAt = now
 *     ‚Üì
 * 10. Refetch order ‚Üí Update UI (show "Delivered")
 *
 * ============================================================================
 */
